<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Pooh's Honey Barrel - Complete Working Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description" content="A fully functional Winnie-the-Pooh storybook game with all features working." />
    <meta name="theme-color" content="#f7c948" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800;900&family=Playfair+Display:wght@400;600;700;800&family=Schoolbell&display=swap" rel="stylesheet" />
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* ===== CSS Variables & Reset ===== */
        :root {
            --pooh-yellow: #f7c948;
            --pooh-yellow-light: #ffe7a3;
            --pooh-yellow-dark: #e0a81b;
            --pooh-red: #d64545;
            --pooh-red-light: #ff6b6b;
            --page-cream: #fdf5e6;
            --page-edge: #f2e1c4;
            --ink-brown: #3e2723;
            --ink-soft: #5d4037;
            --bg-honey: #fff4ce;
            --shadow-md: 0 10px 24px rgba(102, 72, 39, 0.18);
            --shadow-lg: 0 20px 40px rgba(102, 72, 39, 0.25);
            --shadow-sm: 0 4px 10px rgba(102, 72, 39, 0.14);
            --radius-md: 18px;
            --radius-lg: 26px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --success-green: #4CAF50;
            --warning-orange: #FF9800;
            --info-blue: #2196F3;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            height: 100%;
            touch-action: manipulation;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Nunito", system-ui, sans-serif;
            background:
                radial-gradient(circle at top left, #ffe9c4 0, transparent 50%),
                radial-gradient(circle at bottom right, #ffd9b0 0, transparent 50%),
                linear-gradient(135deg, #f7e0c2, #f2d6a9);
            color: var(--ink-brown);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 14px;
            padding-left: calc(14px + env(safe-area-inset-left));
            padding-right: calc(14px + env(safe-area-inset-right));
            padding-top: calc(14px + env(safe-area-inset-top));
            padding-bottom: calc(14px + env(safe-area-inset-bottom));
            position: relative;
            overflow-y: auto;
        }
        
        /* Particle background */
        #particles-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }
        
        .toast {
            background: white;
            border-radius: var(--radius-md);
            padding: 14px 18px;
            box-shadow: var(--shadow-lg);
            border-left: 5px solid var(--pooh-yellow);
            transform: translateX(400px);
            opacity: 0;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.5s forwards;
        }
        
        .toast.success { border-left-color: var(--success-green); }
        .toast.warning { border-left-color: var(--warning-orange); }
        .toast.error { border-left-color: var(--pooh-red); }
        .toast.info { border-left-color: var(--info-blue); }
        
        @keyframes slideIn {
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Storybook page frame */
        .page-frame {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: linear-gradient(135deg, #f4e0c3, #e8cfad);
            border-radius: 24px;
            box-shadow:
                0 24px 60px rgba(96, 63, 32, 0.3),
                0 0 0 2px rgba(255, 255, 255, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        .page-frame::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, 
                #f7c948, #f29d4b, #f7c948, #f29d4b, #f7c948);
            z-index: 2;
        }
        
        .page {
            border-radius: 18px;
            background:
                repeating-linear-gradient(
                    to bottom,
                    rgba(255, 255, 255, 0.95),
                    rgba(255, 255, 255, 0.95) 32px,
                    rgba(255, 250, 235, 0.95) 33px
                ),
                var(--page-cream);
            border: 1px solid rgba(153, 110, 56, 0.35);
            padding: 24px 20px 28px;
            margin: 6px;
            box-shadow:
                inset 0 0 0 1px rgba(255, 255, 255, 0.8),
                var(--shadow-md);
            position: relative;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
            align-items: start;
        }

        .story-column {
            order: -1;
        }

        .game-column {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        
        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            left: -999px;
            top: auto;
            width: 1px;
            height: 1px;
            overflow: hidden;
            z-index: 9999;
        }
        
        .skip-link:focus {
            position: fixed;
            left: 20px;
            top: 20px;
            width: auto;
            height: auto;
            padding: 12px 16px;
            background: var(--ink-brown);
            color: white;
            border-radius: var(--radius-md);
            font-weight: 600;
            text-decoration: none;
            box-shadow: var(--shadow-lg);
        }
        
        /* Header / Story title */
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .logo-container {
            position: relative;
            display: inline-block;
            margin-bottom: 16px;
        }
        
        .logo-icon {
            width: 88px;
            height: 88px;
            border-radius: 24px;
            background: 
                radial-gradient(circle at 30% 30%, #fff8d9 0, #f7c948 45%, #e0a81b 100%);
            box-shadow: 
                0 12px 30px rgba(204, 149, 67, 0.6),
                inset 0 4px 12px rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            transform: rotate(-5deg);
            transition: var(--transition);
        }
        
        .logo-icon:hover {
            transform: rotate(5deg) scale(1.05);
        }
        
        .logo-icon::after {
            content: "";
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            border-radius: 30px;
            border: 3px solid var(--pooh-yellow-light);
            opacity: 0.5;
            pointer-events: none;
        }
        
        h1 {
            font-family: "Playfair Display", Georgia, "Times New Roman", serif;
            font-weight: 800;
            font-size: 2.4rem;
            margin: 0 0 4px;
            letter-spacing: 0.04em;
            background: linear-gradient(135deg, var(--ink-brown), var(--ink-soft));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.5);
        }
        
        .subtitle {
            font-family: "Schoolbell", system-ui, sans-serif;
            font-size: 1.1rem;
            color: var(--ink-soft);
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .divider {
            width: 100px;
            height: 5px;
            border-radius: 999px;
            margin: 16px auto 8px;
            background: linear-gradient(90deg, 
                #f7c948, #f29d4b 30%, #f7c948 70%, #f29d4b);
            position: relative;
            overflow: hidden;
        }
        
        .divider::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }
        
        .chapter-label {
            font-size: 0.85rem;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: rgba(62, 39, 35, 0.7);
            margin-bottom: 12px;
            font-weight: 700;
        }
        
        /* Storybox / Event details */
        .story-box {
            background: rgba(255, 250, 235, 0.95);
            border-radius: var(--radius-lg);
            padding: 20px 20px 18px;
            margin-bottom: 22px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(153, 110, 56, 0.25);
            position: relative;
            overflow: hidden;
        }
        
        .story-box::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(to bottom, #f7c948, #f29d4b);
        }
        
        .story-text {
            font-size: 1rem;
            line-height: 1.7;
            color: var(--ink-soft);
            margin-bottom: 12px;
            text-align: justify;
        }
        
        .story-text:first-letter {
            font-family: "Playfair Display", serif;
            font-size: 2.2rem;
            float: left;
            line-height: 0.8;
            padding-right: 8px;
            padding-top: 6px;
            color: var(--pooh-red);
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.1);
        }
        
        .event-list {
            border-top: 2px dashed rgba(153, 110, 56, 0.3);
            margin-top: 14px;
            padding-top: 14px;
            font-size: 0.92rem;
        }
        
        .event-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            align-items: center;
        }
        
        .event-label {
            font-weight: 700;
            color: var(--ink-brown);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .event-label i {
            color: var(--pooh-yellow-dark);
            font-size: 0.9rem;
        }
        
        /* Game shell */
        .game-shell {
            background: rgba(255, 252, 240, 0.98);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 20px 18px 24px;
            border: 1px solid rgba(153, 110, 56, 0.35);
            position: relative;
            overflow: hidden;
        }
        
        .game-shell::before {
            content: "";
            position: absolute;
            inset: 8px 12px auto 12px;
            height: 5px;
            border-radius: 999px;
            background: linear-gradient(90deg, 
                #f7c948, #f29d4b 30%, #f7c948 70%, #f29d4b);
            opacity: 0.7;
        }
        
        .game-shell header {
            text-align: left;
            margin-bottom: 16px;
        }
        
        .game-shell h2 {
            font-family: "Schoolbell", system-ui, sans-serif;
            font-size: 1.8rem;
            margin: 4px 0 6px;
            color: var(--ink-brown);
        }
        
        .game-shell p {
            margin: 0;
            font-size: 0.96rem;
            color: var(--ink-soft);
            line-height: 1.5;
        }
        
        /* Stats row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 18px 0 16px;
        }

        .stat-pill {
            background: linear-gradient(135deg, var(--bg-honey), var(--pooh-yellow-light));
            border-radius: 14px;
            padding: 10px 14px;
            box-shadow: var(--shadow-sm);
            font-size: 0.82rem;
            border: 1px solid rgba(153, 110, 56, 0.3);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            min-height: 64px;
            gap: 2px;
        }
        
        .stat-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 72, 39, 0.2);
        }
        
        .stat-pill--highlight {
            background: linear-gradient(135deg, #ffe08a, #f7c948);
            border-color: rgba(224, 168, 27, 0.7);
            box-shadow: 0 10px 24px rgba(224, 168, 27, 0.25);
        }
        
        .stat-label {
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.05em;
            color: rgba(62, 39, 35, 0.75);
            font-size: 0.7rem;
        }
        
        .stat-value {
            font-weight: 900;
            font-size: 1.35rem;
            line-height: 1;
        }
        
        /* Settings row */
        .settings-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
            align-items: center;
        }
        
        .settings-group {
            flex: 1;
            min-width: 180px;
        }
        
        .settings-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.88rem;
            font-weight: 700;
            color: var(--ink-soft);
            margin-bottom: 6px;
        }
        
        .settings-group label i {
            color: var(--pooh-yellow-dark);
        }
        
        select, .btn-toggle {
            width: 100%;
            padding: 10px 14px;
            font-size: 0.9rem;
            border-radius: 999px;
            border: 1px solid rgba(153, 110, 56, 0.35);
            background: #fffdf6;
            color: var(--ink-brown);
            font-family: "Nunito", sans-serif;
            transition: var(--transition);
            cursor: pointer;
        }
        
        select:focus, .btn-toggle:focus {
            outline: none;
            border-color: var(--pooh-yellow);
            box-shadow: 0 0 0 3px rgba(247, 201, 72, 0.3);
        }
        
        .btn-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #fffdf6, #f5f0e1);
        }
        
        .btn-toggle.active {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-color: var(--success-green);
        }
        
        .toggle-icon {
            font-size: 1rem;
            color: var(--ink-soft);
        }
        
        .btn-toggle.active .toggle-icon {
            color: var(--success-green);
        }
        
        /* Canvas area */
        .canvas-shell {
            margin-bottom: 16px;
            border-radius: var(--radius-md);
            padding: 8px;
            background: linear-gradient(135deg, #ffe7b2, #ffd18a);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }
        
        .canvas-shell::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                transparent, rgba(255, 255, 255, 0.7), transparent);
        }
        
        .canvas-inner {
            border-radius: var(--radius-md);
            overflow: hidden;
            background: linear-gradient(180deg, #cbe3ff, #a8d0ff);
            position: relative;
            aspect-ratio: 4 / 3;
            min-height: 280px;
        }
        
        .game-canvas {
            display: block;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        
        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 24px;
            background: rgba(255, 249, 226, 0.97);
            backdrop-filter: blur(5px);
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        
        .overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .overlay-title {
            font-family: "Schoolbell", system-ui, sans-serif;
            font-size: 1.9rem;
            margin-bottom: 12px;
            color: var(--ink-brown);
        }
        
        .overlay-text {
            font-size: 1rem;
            color: var(--ink-soft);
            line-height: 1.5;
            max-width: 320px;
        }
        
        .overlay-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 16px 0;
            text-align: left;
            background: rgba(255, 255, 255, 0.7);
            padding: 16px;
            border-radius: var(--radius-md);
            width: 100%;
            max-width: 320px;
        }
        
        .overlay-stat {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
        }
        
        .overlay-stat-value {
            font-weight: 700;
            color: var(--pooh-yellow-dark);
        }
        
        /* Controls */
        .controls-row {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1 1 170px;
            border: none;
            border-radius: 999px;
            padding: 16px 20px;
            font-size: 1.05rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            font-family: "Nunito", sans-serif;
            position: relative;
            overflow: hidden;
            min-height: 56px;
            -webkit-touch-callout: none;
        }
        
        .btn::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.7s;
        }
        
        .btn:hover::after {
            left: 100%;
        }
        
        .btn:active {
            transform: scale(0.97);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--pooh-yellow), var(--pooh-yellow-dark));
            color: var(--ink-brown);
            flex: 1.2;
            letter-spacing: 0.01em;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #ffd54f, #f0b429);
            box-shadow: 0 8px 20px rgba(247, 201, 72, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #fffdf6, #f5f0e1);
            color: var(--ink-soft);
            border: 1px solid rgba(153, 110, 56, 0.3);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #fff, #f0ebe1);
            box-shadow: 0 8px 20px rgba(102, 72, 39, 0.15);
        }
        
        .btn-tertiary {
            background: transparent;
            color: var(--ink-soft);
            border: 1px solid rgba(153, 110, 56, 0.3);
            box-shadow: none;
        }
        
        .btn-tertiary:hover {
            background: rgba(153, 110, 56, 0.05);
        }
        
        /* Status bar */
        .status {
            font-size: 0.86rem;
            padding: 12px 14px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(255, 249, 230, 0.9), rgba(255, 245, 215, 0.9));
            color: var(--ink-soft);
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(153, 110, 56, 0.2);
            margin-top: 4px;
        }
        
        .status i {
            color: var(--pooh-yellow-dark);
            font-size: 1.1rem;
        }
        
        /* Instructions modal */
        .instructions-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 20px;
        }
        
        .instructions-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .instructions-content {
            background: var(--page-cream);
            border-radius: var(--radius-lg);
            padding: 28px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(153, 110, 56, 0.35);
            position: relative;
        }
        
        .instructions-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--ink-soft);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .instructions-close:hover {
            background: rgba(153, 110, 56, 0.1);
        }
        
        .instructions-list {
            list-style: none;
            margin: 20px 0;
        }
        
        .instructions-list li {
            padding: 10px 0;
            border-bottom: 1px dashed rgba(153, 110, 56, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .instructions-list li:last-child {
            border-bottom: none;
        }
        
        .instructions-list i {
            color: var(--pooh-yellow-dark);
            font-size: 1.2rem;
            width: 24px;
        }
        
        /* Mobile-specific controls */
        .mobile-controls {
            display: none;
            position: relative;
            margin-top: 15px;
            height: 140px;
            touch-action: none;
        }
        
        .mobile-controls.active {
            display: block;
        }
        
        .control-pad {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .control-btn {
            width: 76px;
            height: 76px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pooh-yellow), var(--pooh-yellow-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--ink-brown);
            box-shadow: var(--shadow-lg);
            border: 3px solid rgba(255, 255, 255, 0.5);
            opacity: 0.9;
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
        }
        
        .control-btn:active {
            transform: scale(0.9);
            opacity: 1;
        }
        
        /* Footer */
        footer {
            text-align: center;
            font-size: 0.8rem;
            color: rgba(62, 39, 35, 0.7);
            margin-top: 20px;
            font-style: italic;
            padding-top: 16px;
            border-top: 1px solid rgba(153, 110, 56, 0.2);
        }
        
        footer i {
            color: var(--pooh-red);
        }
        
        /* Responsive adjustments - MOBILE FIRST */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                align-items: flex-start;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .page-frame {
                margin: 8px 0;
                max-width: 540px;
            }
            
            .page {
                padding: 18px 14px 22px;
                margin: 4px;
            }

            .content-grid {
                gap: 14px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .logo-icon {
                width: 70px;
                height: 70px;
                font-size: 2.2rem;
            }
            
            .game-shell h2 {
                font-size: 1.4rem;
            }
            
            .story-text {
                font-size: 0.95rem;
                line-height: 1.6;
            }
            
            .stats-row {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .stat-pill {
                padding: 8px 12px;
                min-height: 56px;
            }
            
            .stat-pill--highlight {
                grid-column: span 3;
                order: -1;
            }
            
            .settings-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .settings-group {
                min-width: 100%;
            }
            
            .canvas-inner {
                aspect-ratio: 1 / 1.4;
            }
            
            .controls-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn {
                width: 100%;
                padding: 16px 18px;
                font-size: 1.1rem;
                min-height: 56px;
            }
            
            .status {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                font-size: 0.9rem;
            }
            
            .mobile-controls.active {
                display: block;
            }
            
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: 100%;
            }
            
            .toast {
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            
            .instructions-modal {
                padding: 10px;
            }
            
            .instructions-content {
                padding: 20px;
            }
        }

        @media (min-width: 900px) {
            .page {
                padding: 26px 22px 30px;
            }

            .content-grid {
                grid-template-columns: minmax(340px, 1fr) minmax(520px, 1.15fr);
                gap: 20px;
            }

            .story-column {
                order: 0;
            }
        }

        /* Tablet */
        @media (min-width: 769px) and (max-width: 1024px) {
            .page-frame {
                max-width: 100%;
            }

            .canvas-inner {
                aspect-ratio: 4 / 3;
            }

            .content-grid {
                gap: 18px;
            }

            .stats-row {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .mobile-controls {
                display: none !important;
            }
        }
        
        /* Desktop */
        @media (min-width: 1025px) {
            body {
                padding: 26px 32px;
                align-items: flex-start;
                overflow-y: auto;
            }

            .page-frame {
                max-width: 1200px;
            }

            .page {
                padding: 30px 26px 34px;
            }

            .content-grid {
                grid-template-columns: minmax(380px, 1fr) minmax(560px, 1.2fr);
                gap: 24px;
            }

            .canvas-inner {
                aspect-ratio: 16 / 10;
            }

            .mobile-controls {
                display: none !important;
            }

            .btn {
                min-width: 160px;
            }

            .stats-row {
                grid-template-columns: repeat(5, minmax(0, 1fr));
            }

            .game-shell {
                padding: 26px 24px 30px;
            }
        }
        
        /* Landscape mode for mobile */
        @media (max-height: 600px) and (orientation: landscape) {
            body {
                align-items: flex-start;
                padding: 5px;
            }
            
            .page-frame {
                margin: 5px 0;
                max-height: 96vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .page {
                padding: 12px 14px 16px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .logo-icon {
                width: 50px;
                height: 50px;
                font-size: 1.8rem;
                margin-bottom: 8px;
            }
            
            .story-box {
                padding: 12px 14px;
                margin-bottom: 12px;
            }
            
            .game-shell {
                padding: 14px 12px 18px;
            }
            
            .stats-row {
                grid-template-columns: repeat(5, 1fr);
                gap: 6px;
                margin: 12px 0;
            }
            
            .stat-pill {
                padding: 6px 8px;
                min-height: 48px;
            }
            
            .canvas-inner {
                aspect-ratio: 1 / 1;
            }
            
            .controls-row {
                flex-direction: row;
                margin-bottom: 10px;
            }
            
            .btn {
                padding: 10px 12px;
                min-height: 44px;
                font-size: 0.9rem;
            }
        }
        
        /* High score animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 0.5s ease;
        }
        
        /* Confetti animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--pooh-yellow);
            top: -10px;
            z-index: 999;
        }
        
        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(247, 201, 72, 0.3);
            border-radius: 50%;
            border-top-color: var(--pooh-yellow);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Shake animation for bee hits */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.5s ease;
        }
        
        /* Prevent text selection */
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Hide scrollbar but keep functionality */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Skip link for accessibility -->
    <a href="#main" class="skip-link">Skip to main content</a>
    
    <!-- Toast container for notifications -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Instructions modal -->
    <div class="instructions-modal" id="instructionsModal" role="dialog" aria-modal="true" aria-labelledby="instructionsTitle" aria-describedby="instructionsIntro" aria-hidden="true">
        <div class="instructions-content" tabindex="-1">
            <button class="instructions-close" id="instructionsClose" aria-label="Close instructions">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="overlay-title" id="instructionsTitle">How to Play</h2>
            <p class="overlay-text" id="instructionsIntro">Help Pooh Bear catch as many honeybee drops as possible!</p>
            
            <ul class="instructions-list">
                <li>
                    <i class="fas fa-mouse-pointer"></i>
                    <span><strong>Desktop:</strong> Use mouse to drag or arrow keys</span>
                </li>
                <li>
                    <i class="fas fa-mobile-alt"></i>
                    <span><strong>Mobile:</strong> Touch and drag or use on-screen buttons</span>
                </li>
                <li>
                    <i class="fas fa-tint"></i>
                    <span><strong>Catch Honey Drops:</strong> Collect glowing drops for points</span>
                </li>
                <li>
                    <i class="fas fa-crown"></i>
                    <span><strong>Golden Drops:</strong> Special drops worth double points</span>
                </li>
                <li>
                    <i class="fas fa-bug"></i>
                    <span><strong>Avoid Bees:</strong> Hitting bees reduces score and time</span>
                </li>
                <li>
                    <i class="fas fa-bolt"></i>
                    <span><strong>Streak Multiplier:</strong> Catch 3 drops in a row for bonus points</span>
                </li>
                <li>
                    <i class="fas fa-sliders-h"></i>
                    <span><strong>Difficulty:</strong> Adjust game speed and challenge level</span>
                </li>
            </ul>
            
            <div class="controls-row">
                <button class="btn btn-primary" id="startFromInstructions">
                    <i class="fas fa-play"></i> Start Game
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main game container -->
    <div class="page-frame">
        <div class="page">
            <header>
                <div class="logo-container">
                    <div class="logo-icon" aria-hidden="true">üçØ</div>
                </div>
                <div class="chapter-label">A Hundred Acre Mini-Adventure</div>
                <h1>Pooh's Honey Barrel</h1>
                <div class="divider"></div>
                <p class="subtitle">Pooh carries his barrel, honeybee drops fall from the sky, and the bees are very, very busy.</p>
            </header>

            <div class="content-grid">
                <!-- Story intro / invitation -->
                <section class="story-box story-column" aria-label="Story introduction">
                    <p class="story-text">
                        Once upon an afternoon in the Hundred Acre Wood, Pooh Bear found his honey cupboard terribly empty. So he picked up his very best barrel, stepped out into the sunshine, and waited for the honeybees to share a few drippy drops from the sky. Of course, the bees themselves were not to be bumped into, because bees have very particular feelings about bears and barrels.
                    </p>
                    <div class="event-list">
                        <div class="event-row">
                            <span class="event-label">
                                <i class="fas fa-calendar-day"></i>
                                When:
                            </span>
                            <span>April 24 ¬∑ 2:00‚Äì5:00 PM</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">
                                <i class="fas fa-map-marker-alt"></i>
                                Where:
                            </span>
                            <span>The Hundred Acre Wood</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">
                                <i class="fas fa-gamepad"></i>
                                Your Part:
                            </span>
                            <span>Help Pooh catch the honeybee drops!</span>
                        </div>
                    </div>
                </section>

                <main id="main" class="game-column">
                    <section class="game-shell" aria-label="Honey Barrel game">
                    <header>
                        <h2>The Honey Barrel Game</h2>
                        <p>Slide Pooh along the ground with your finger (or mouse). Catch the glowing honeybee drops in his barrel, avoid the buzzing bees, and see how high your storybook score can go.</p>
                    </header>
                    
                    <!-- Stats -->
                    <div class="stats-row">
                        <div class="stat-pill stat-pill--highlight">
                            <div class="stat-label">Score</div>
                            <div class="stat-value" id="score">0</div>
                        </div>
                        <div class="stat-pill">
                            <div class="stat-label">Time</div>
                            <div class="stat-value" id="time">60</div>
                        </div>
                        <div class="stat-pill">
                            <div class="stat-label">Drops</div>
                            <div class="stat-value" id="caught">0</div>
                        </div>
                        <div class="stat-pill">
                            <div class="stat-label">Best</div>
                            <div class="stat-value" id="best">0</div>
                        </div>
                        <div class="stat-pill">
                            <div class="stat-label">Streak</div>
                            <div class="stat-value" id="streak">x1</div>
                        </div>
                    </div>
                    
                    <!-- Settings -->
                    <div class="settings-row">
                        <div class="settings-group">
                            <label for="difficulty">
                                <i class="fas fa-sliders-h"></i>
                                Honey Weather
                            </label>
                            <select id="difficulty">
                                <option value="easy">Gentle Drips</option>
                                <option value="medium" selected>Busy Bees</option>
                                <option value="hard">Honey Storm</option>
                                <option value="expert">Bee Swarm</option>
                            </select>
                        </div>
                        <div class="settings-group">
                            <label for="soundToggle">
                                <i class="fas fa-volume-up"></i>
                                Sound Effects
                            </label>
                            <button class="btn-toggle active" id="soundToggle">
                                <span>On</span>
                                <span class="toggle-icon"><i class="fas fa-check"></i></span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Canvas -->
                    <div class="canvas-shell">
                        <div class="canvas-inner">
                            <canvas id="gameCanvas" class="game-canvas" 
                                    aria-label="Game area where Pooh catches honey drops and avoids bees"
                                    role="application"></canvas>
                            <div class="overlay" id="overlay">
                                <div class="overlay-title" id="overlayTitle">Ready, Pooh?</div>
                                <div class="overlay-text" id="overlayText">
                                    Tap <strong>Start</strong>, then slide your finger to move Pooh and his barrel.
                                    Catch the glowing <strong>honeybee drops</strong>, but mind the <strong>bees</strong> ‚Äî they don't like barrels bumping into them.
                                </div>
                                <div class="overlay-stats" id="overlayStats" style="display: none;">
                                    <div class="overlay-stat">
                                        <span>Final Score:</span>
                                        <span class="overlay-stat-value" id="finalScore">0</span>
                                    </div>
                                    <div class="overlay-stat">
                                        <span>Drops Caught:</span>
                                        <span class="overlay-stat-value" id="finalCaught">0</span>
                                    </div>
                                    <div class="overlay-stat">
                                        <span>Best Streak:</span>
                                        <span class="overlay-stat-value" id="finalStreak">x1</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Controls (shown only on mobile) -->
                    <div class="mobile-controls" id="mobileControls">
                        <div class="control-pad">
                            <button class="control-btn" id="leftBtn" aria-label="Move left">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <button class="control-btn" id="rightBtn" aria-label="Move right">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Controls -->
                    <div class="controls-row" aria-label="Game controls">
                        <button class="btn btn-primary" id="startBtn">
                            <i class="fas fa-play"></i> Start
                        </button>
                        <button class="btn btn-secondary" id="pauseBtn" disabled>
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button class="btn btn-tertiary" id="helpBtn">
                            <i class="fas fa-question-circle"></i> Help
                        </button>
                    </div>
                    
                    <!-- Status -->
                    <div class="status" id="status" role="status" aria-live="polite">
                        <i class="fas fa-feather-pointed"></i>
                        <span id="statusText">Start the game, then move Pooh left and right to catch honey drops.</span>
                    </div>
                    </section>
                </main>
            </div>

            <footer>
                <p>Told with warmth in the Hundred Acre Wood &mdash; a little fan-made storybook game.</p>
                <p><small><i class="fas fa-heart"></i> Not affiliated with Disney. Made with honey and care.</small></p>
            </footer>
        </div>
    </div>
    
    <!-- Particle background canvas -->
    <canvas id="particles-background"></canvas>
    
    <script>
        (function() {
            'use strict';
            
            // ==================== Device Detection ====================
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            let isLandscape = window.innerWidth > window.innerHeight;
            
            // ==================== Game Constants & Configuration ====================
            const DIFFICULTY_CONFIG = {
                easy: {
                    drops: isMobile ? 2 : 3,
                    bees: 1,
                    minSpeed: isMobile ? 60 : 70,
                    maxSpeed: isMobile ? 100 : 120,
                    dropScore: 30,
                    duration: isMobile ? 75 : 70,
                    beePenalty: isMobile ? 15 : 20,
                    timePenalty: isMobile ? 1 : 2,
                    playerSpeed: isMobile ? 0.25 : 0.15
                },
                medium: {
                    drops: isMobile ? 3 : 4,
                    bees: isMobile ? 1 : 2,
                    minSpeed: isMobile ? 80 : 100,
                    maxSpeed: isMobile ? 150 : 180,
                    dropScore: 50,
                    duration: isMobile ? 65 : 60,
                    beePenalty: isMobile ? 30 : 40,
                    timePenalty: isMobile ? 2 : 3,
                    playerSpeed: isMobile ? 0.3 : 0.2
                },
                hard: {
                    drops: isMobile ? 4 : 5,
                    bees: isMobile ? 2 : 3,
                    minSpeed: isMobile ? 120 : 140,
                    maxSpeed: isMobile ? 200 : 240,
                    dropScore: 75,
                    duration: isMobile ? 55 : 50,
                    beePenalty: isMobile ? 45 : 60,
                    timePenalty: isMobile ? 3 : 4,
                    playerSpeed: isMobile ? 0.35 : 0.25
                },
                expert: {
                    drops: isMobile ? 5 : 6,
                    bees: isMobile ? 3 : 4,
                    minSpeed: isMobile ? 150 : 180,
                    maxSpeed: isMobile ? 250 : 300,
                    dropScore: 100,
                    duration: isMobile ? 45 : 40,
                    beePenalty: isMobile ? 60 : 80,
                    timePenalty: isMobile ? 4 : 5,
                    playerSpeed: isMobile ? 0.4 : 0.3
                }
            };
            
            const STORAGE_KEYS = {
                BEST_SCORE: 'pooh_honey_barrel_best',
                SOUND_ENABLED: 'pooh_honey_barrel_sound',
                DIFFICULTY: 'pooh_honey_barrel_difficulty'
            };
            
            // ==================== Utility Functions ====================
            function clamp(value, min, max) {
                return Math.max(min, Math.min(max, value));
            }
            
            function randomRange(min, max) {
                return min + Math.random() * (max - min);
            }
            
            function randomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            
            function lerp(start, end, amount) {
                return start + (end - start) * amount;
            }
            
            // ==================== Audio Manager ====================
            class AudioManager {
                constructor() {
                    this.enabled = true;
                    this.audioContext = null;
                    this.gainNode = null;
                    this.loadFromStorage();
                }
                
                loadFromStorage() {
                    try {
                        const stored = localStorage.getItem(STORAGE_KEYS.SOUND_ENABLED);
                        this.enabled = stored !== 'false';
                    } catch (e) {
                        this.enabled = true;
                    }
                }
                
                saveToStorage() {
                    try {
                        localStorage.setItem(STORAGE_KEYS.SOUND_ENABLED, this.enabled.toString());
                    } catch (e) {}
                }
                
                toggle() {
                    this.enabled = !this.enabled;
                    this.saveToStorage();
                    return this.enabled;
                }
                
                initAudioContext() {
                    if (this.audioContext) return;
                    
                    try {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        this.gainNode = this.audioContext.createGain();
                        this.gainNode.connect(this.audioContext.destination);
                        this.gainNode.gain.value = 0.3;
                    } catch (e) {
                        console.warn('Web Audio API not supported');
                    }
                }
                
                playTone(frequency, duration, type = 'sine', volume = 0.2) {
                    if (!this.enabled || !this.audioContext) return;
                    
                    try {
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                        oscillator.type = type;
                        
                        gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                        
                        oscillator.start(this.audioContext.currentTime);
                        oscillator.stop(this.audioContext.currentTime + duration);
                    } catch (e) {}
                }
                
                playDropSound() {
                    this.playTone(523.25, 0.1, 'sine', 0.15);
                    this.playTone(659.25, 0.2, 'sine', 0.1);
                }
                
                playGoldenDropSound() {
                    this.playTone(783.99, 0.15, 'sine', 0.2);
                    this.playTone(1046.50, 0.3, 'sine', 0.15);
                }
                
                playBeeHitSound() {
                    this.playTone(110, 0.3, 'sawtooth', 0.25);
                    this.playTone(87.31, 0.4, 'sawtooth', 0.2);
                }
                
                playGameOverSound() {
                    this.playTone(220, 0.2, 'sine', 0.2);
                    this.playTone(196, 0.4, 'sine', 0.15);
                    this.playTone(174.61, 0.6, 'sine', 0.1);
                }
                
                playStartSound() {
                    this.playTone(659.25, 0.1, 'sine', 0.2);
                    this.playTone(783.99, 0.2, 'sine', 0.15);
                    this.playTone(1046.50, 0.3, 'sine', 0.1);
                }
            }
            
            // ==================== Particle System ====================
            class ParticleSystem {
                constructor(canvas) {
                    this.canvas = canvas;
                    this.ctx = canvas.getContext('2d');
                    this.particles = [];
                    this.resize();
                    
                    window.addEventListener('resize', () => this.resize());
                }
                
                resize() {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                    this.width = this.canvas.width;
                    this.height = this.canvas.height;
                }
                
                createParticles(x, y, count, color, size = 2) {
                    for (let i = 0; i < count; i++) {
                        this.particles.push({
                            x: x,
                            y: y,
                            size: randomRange(size * 0.5, size * 1.5),
                            speedX: randomRange(-2, 2),
                            speedY: randomRange(-3, 0),
                            color: color,
                            life: 1,
                            decay: randomRange(0.01, 0.03),
                            gravity: 0.1
                        });
                    }
                }
                
                createHoneyParticles(x, y) {
                    this.createParticles(x, y, isMobile ? 10 : 15, '#FFD54F', 3);
                }
            
                createGoldenParticles(x, y) {
                    this.createParticles(x, y, isMobile ? 15 : 25, '#FFC107', 4);
                }
                
                createBeeParticles(x, y) {
                    this.createParticles(x, y, isMobile ? 15 : 20, '#FF6F00', 2.5);
                }
                
                createConfetti() {
                    const colors = ['#FFD54F', '#FFC107', '#FFA000', '#FF6F00', '#FFEB3B'];
                    const count = isMobile ? 30 : 50;
                    for (let i = 0; i < count; i++) {
                        this.particles.push({
                            x: randomRange(0, this.width),
                            y: -10,
                            size: randomRange(4, 8),
                            speedX: randomRange(-2, 2),
                            speedY: randomRange(2, 5),
                            color: colors[randomInt(0, colors.length - 1)],
                            life: 1,
                            decay: randomRange(0.005, 0.015),
                            gravity: 0.05,
                            rotation: 0,
                            rotationSpeed: randomRange(-0.1, 0.1)
                        });
                    }
                }
                
                update() {
                    for (let i = this.particles.length - 1; i >= 0; i--) {
                        const p = this.particles[i];
                        
                        p.x += p.speedX;
                        p.y += p.speedY;
                        p.speedY += p.gravity;
                        p.life -= p.decay;
                        
                        if (p.rotation !== undefined) {
                            p.rotation += p.rotationSpeed;
                        }
                        
                        if (p.life <= 0 || p.y > this.height) {
                            this.particles.splice(i, 1);
                        }
                    }
                }
                
                draw() {
                    this.ctx.clearRect(0, 0, this.width, this.height);
                    
                    for (const p of this.particles) {
                        this.ctx.save();
                        this.ctx.globalAlpha = p.life;
                        this.ctx.fillStyle = p.color;
                        
                        if (p.rotation !== undefined) {
                            this.ctx.translate(p.x, p.y);
                            this.ctx.rotate(p.rotation);
                            this.ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                        } else {
                            this.ctx.beginPath();
                            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                            this.ctx.fill();
                        }
                        
                        this.ctx.restore();
                    }
                }
            }
            
            // ==================== Toast Notification System ====================
            class ToastManager {
                constructor(containerId) {
                    this.container = document.getElementById(containerId);
                }
                
                show(message, type = 'info', duration = 3000) {
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.innerHTML = `
                        <i class="fas ${this.getIconForType(type)}"></i>
                        <span>${message}</span>
                    `;
                    
                    this.container.appendChild(toast);
                    
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transform = 'translateX(400px)';
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.parentNode.removeChild(toast);
                            }
                        }, 500);
                    }, duration);
                }
                
                getIconForType(type) {
                    switch(type) {
                        case 'success': return 'fa-check-circle';
                        case 'warning': return 'fa-exclamation-triangle';
                        case 'error': return 'fa-times-circle';
                        case 'info': default: return 'fa-info-circle';
                    }
                }
            }
            
            // ==================== Main Game Class ====================
            class PoohHoneyBarrelGame {
                constructor() {
                    // Device capabilities
                    this.isMobile = isMobile;
                    this.isTouchDevice = isTouchDevice;
                    this.isLandscape = isLandscape;
                    
                    // DOM Elements
                    this.canvas = document.getElementById('gameCanvas');
                    this.ctx = this.canvas.getContext('2d');
                    
                    this.scoreEl = document.getElementById('score');
                    this.timeEl = document.getElementById('time');
                    this.caughtEl = document.getElementById('caught');
                    this.bestEl = document.getElementById('best');
                    this.streakEl = document.getElementById('streak');
                    this.statusText = document.getElementById('statusText');
                    this.overlay = document.getElementById('overlay');
                    this.overlayTitle = document.getElementById('overlayTitle');
                    this.overlayText = document.getElementById('overlayText');
                    this.overlayStats = document.getElementById('overlayStats');
                    this.finalScore = document.getElementById('finalScore');
                    this.finalCaught = document.getElementById('finalCaught');
                    this.finalStreak = document.getElementById('finalStreak');
                    
                    this.startBtn = document.getElementById('startBtn');
                    this.pauseBtn = document.getElementById('pauseBtn');
                    this.helpBtn = document.getElementById('helpBtn');
                    this.difficultySelect = document.getElementById('difficulty');
                    this.soundToggle = document.getElementById('soundToggle');
                    this.instructionsModal = document.getElementById('instructionsModal');
                    this.instructionsClose = document.getElementById('instructionsClose');
                    this.instructionsContent = this.instructionsModal.querySelector('.instructions-content');
                    this.startFromInstructions = document.getElementById('startFromInstructions');
                    
                    // Mobile controls
                    this.mobileControls = document.getElementById('mobileControls');
                    this.leftBtn = document.getElementById('leftBtn');
                    this.rightBtn = document.getElementById('rightBtn');
                    
                    this.lastFocusedElement = null;
                    this.focusableInstructions = [];

                    // Game state
                    this.gameState = 'idle'; // 'idle', 'countdown', 'running', 'paused', 'gameOver'
                    this.timeLeft = 60;
                    this.score = 0;
                    this.caught = 0;
                    this.combo = 0;
                    this.multiplier = 1;
                    this.bestScore = 0;
                    
                    // Game objects
                    this.entities = [];
                    this.popups = [];
                    this.particles = [];
                    
                    // Player - adjust size based on device
                    this.player = {
                        x: 0,
                        y: 0,
                        width: this.isMobile ? 90 : 82,
                        height: this.isMobile ? 60 : 50,
                        targetX: 0,
                        lerpSpeed: 0.15,
                        moveLeft: false,
                        moveRight: false,
                        moveSpeed: 15
                    };
                    
                    // Timing
                    this.lastFrameTime = 0;
                    this.timerInterval = null;
                    this.beeHitTimer = 0;
                    this.cloudOffset = 0;
                    this.countdown = 3;
                    this.controlUpdateInterval = null;
                    this.countdownInterval = null;
                    
                    // Systems - NEED TO INITIALIZE THESE
                    this.audioManager = new AudioManager();
                    this.toastManager = new ToastManager('toastContainer');
                    this.particleSystem = new ParticleSystem(document.getElementById('particles-background'));
                    
                    // Input handling
                    this.touchStartX = 0;
                    this.isDragging = false;
                    this.activeTouches = new Map();

                    // Set initial instructions
                    this.setDeviceSpecificText();
                    
                    // Initialize
                    this.init();
                }
                
                setDeviceSpecificText() {
                    if (this.isMobile) {
                        this.statusText.textContent = 'Tap Start, then drag Pooh or use the on-screen buttons to move.';
                        this.overlayText.innerHTML = 'Tap <strong>Start</strong>, then drag Pooh or use the arrow buttons. Catch <strong>honey drops</strong>, avoid <strong>bees</strong>.';
                    } else {
                        this.statusText.textContent = 'Click Start, then use arrow keys or drag with mouse to move Pooh.';
                        this.overlayText.innerHTML = 'Click <strong>Start</strong>, then use arrow keys or drag with mouse. Catch <strong>honey drops</strong>, avoid <strong>bees</strong>.';
                    }
                }
                
                init() {
                    // Load saved data
                    this.loadBestScore();
                    this.loadDifficulty();
                    
                    // Set up canvas
                    this.resizeCanvas();
                    window.addEventListener('resize', () => this.resizeCanvas());
                    window.addEventListener('orientationchange', () => {
                        setTimeout(() => {
                            this.isLandscape = window.innerWidth > window.innerHeight;
                            this.resizeCanvas();
                            this.toggleMobileControls();
                        }, 250);
                    });
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    // Initialize audio context on first user interaction
                    this.setupAudioActivation();
                    
                    // Show/hide mobile controls
                    this.toggleMobileControls();
                    
                    // Draw initial screen
                    this.drawIdleScreen();
                    
                    // Start background particle animation
                    this.animateBackground();
                    
                    // Show welcome toast
                    setTimeout(() => {
                        const message = this.isMobile 
                            ? 'Welcome! Use touch controls or on-screen buttons.'
                            : 'Welcome! Use arrow keys or mouse to play.';
                        this.toastManager.show(message, 'info', 4000);
                    }, 1000);
                }
                
                toggleMobileControls() {
                    if (this.isMobile && !this.isLandscape) {
                        this.mobileControls.classList.add('active');
                    } else {
                        this.mobileControls.classList.remove('active');
                    }
                }
                
                setupAudioActivation() {
                    const activateAudio = () => {
                        this.audioManager.initAudioContext();
                        document.removeEventListener('click', activateAudio);
                        document.removeEventListener('touchstart', activateAudio);
                    };
                    
                    document.addEventListener('click', activateAudio);
                    document.addEventListener('touchstart', activateAudio);
                }
                
                setupEventListeners() {
                    // Input handling for both mouse and touch
                    this.canvas.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: false });
                    this.canvas.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: false });
                    this.canvas.addEventListener('touchend', (e) => this.handleTouchEnd(e));
                    this.canvas.addEventListener('touchcancel', (e) => this.handleTouchEnd(e));
                    
                    this.canvas.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                    this.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                    this.canvas.addEventListener('mouseup', () => this.handleMouseUp());
                    this.canvas.addEventListener('mouseleave', () => this.handleMouseUp());
                    
                    // Keyboard controls
                    document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                    document.addEventListener('keyup', (e) => this.handleKeyUp(e));
                    
                    // Mobile control buttons
                    if (this.leftBtn && this.rightBtn) {
                        this.leftBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            this.player.moveLeft = true;
                        }, { passive: false });
                        
                        this.leftBtn.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            this.player.moveLeft = false;
                        }, { passive: false });
                        
                        this.leftBtn.addEventListener('touchcancel', (e) => {
                            e.preventDefault();
                            this.player.moveLeft = false;
                        }, { passive: false });
                        
                        this.rightBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            this.player.moveRight = true;
                        }, { passive: false });
                        
                        this.rightBtn.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            this.player.moveRight = false;
                        }, { passive: false });
                        
                        this.rightBtn.addEventListener('touchcancel', (e) => {
                            e.preventDefault();
                            this.player.moveRight = false;
                        }, { passive: false });
                        
                        // For testing on desktop
                        this.leftBtn.addEventListener('mousedown', () => this.player.moveLeft = true);
                        this.leftBtn.addEventListener('mouseup', () => this.player.moveLeft = false);
                        this.leftBtn.addEventListener('mouseleave', () => this.player.moveLeft = false);
                        
                        this.rightBtn.addEventListener('mousedown', () => this.player.moveRight = true);
                        this.rightBtn.addEventListener('mouseup', () => this.player.moveRight = false);
                        this.rightBtn.addEventListener('mouseleave', () => this.player.moveRight = false);
                    }
                    
                    // Button controls
                    this.startBtn.addEventListener('click', () => this.handleStartClick());
                    this.pauseBtn.addEventListener('click', () => this.handlePauseClick());
                    this.helpBtn.addEventListener('click', () => this.showInstructions());
                    
                    // Settings
                    this.difficultySelect.addEventListener('change', () => {
                        this.saveDifficulty();
                        this.toastManager.show(`Difficulty set to: ${this.difficultySelect.options[this.difficultySelect.selectedIndex].text}`, 'info');
                    });
                    
                    this.soundToggle.addEventListener('click', () => {
                        const isEnabled = this.audioManager.toggle();
                        this.soundToggle.classList.toggle('active', isEnabled);
                        this.soundToggle.querySelector('span:first-child').textContent = isEnabled ? 'On' : 'Off';
                        this.toastManager.show(`Sound effects ${isEnabled ? 'enabled' : 'disabled'}`, 'info');
                    });
                    
                    // Instructions modal
                    this.instructionsClose.addEventListener('click', () => this.hideInstructions());
                    this.startFromInstructions.addEventListener('click', () => {
                        this.hideInstructions();
                        this.handleStartClick();
                    });
                    
                    this.instructionsModal.addEventListener('click', (e) => {
                        if (e.target === this.instructionsModal) {
                            this.hideInstructions();
                        }
                    });
                }
                
                handleStartClick() {
                    switch (this.gameState) {
                        case 'idle':
                        case 'gameOver':
                            this.start();
                            break;
                        case 'paused':
                            this.resume();
                            break;
                        case 'running':
                            this.restart();
                            break;
                    }
                }
                
                handlePauseClick() {
                    if (this.gameState === 'running') {
                        this.pause();
                    } else if (this.gameState === 'paused') {
                        this.resume();
                    }
                }
                
                showInstructions() {
                    this.lastFocusedElement = document.activeElement;
                    this.instructionsModal.classList.add('active');
                    this.instructionsModal.setAttribute('aria-hidden', 'false');

                    const focusableElements = this.instructionsModal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    this.focusableInstructions = Array.from(focusableElements);
                    const firstElement = this.focusableInstructions[0];
                    const targetFocus = this.instructionsContent || firstElement;

                    if (targetFocus) {
                        targetFocus.focus();
                    }

                    document.addEventListener('keydown', (this.boundInstructionsKeydown ||= (e) => this.handleInstructionsKeydown(e)));
                }

                hideInstructions() {
                    this.instructionsModal.classList.remove('active');
                    this.instructionsModal.setAttribute('aria-hidden', 'true');

                    if (this.boundInstructionsKeydown) {
                        document.removeEventListener('keydown', this.boundInstructionsKeydown);
                    }

                    if (this.lastFocusedElement && typeof this.lastFocusedElement.focus === 'function') {
                        this.lastFocusedElement.focus();
                    }
                }

                handleInstructionsKeydown(event) {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        this.hideInstructions();
                        return;
                    }

                    if (event.key !== 'Tab' || this.focusableInstructions.length === 0) return;

                    const first = this.focusableInstructions[0];
                    const last = this.focusableInstructions[this.focusableInstructions.length - 1];
                    const active = document.activeElement;

                    if (event.shiftKey && active === first) {
                        event.preventDefault();
                        last.focus();
                    } else if (!event.shiftKey && active === last) {
                        event.preventDefault();
                        first.focus();
                    }
                }
                
                // ==================== Game State Management ====================
                start() {
                    if (this.gameState === 'running') return;
                    
                    this.gameState = 'countdown';
                    this.countdown = 3;
                    
                    // Reset game stats
                    const config = this.getCurrentConfig();
                    this.timeLeft = config.duration;
                    this.score = 0;
                    this.caught = 0;
                    this.combo = 0;
                    this.multiplier = 1;
                    
                    // Update UI
                    this.updateStats();
                    this.overlay.classList.add('active');
                    this.overlayTitle.textContent = 'Ready?';
                    this.overlayText.textContent = `Starting in ${this.countdown}...`;
                    this.overlayStats.style.display = 'none';
                    
                    this.startBtn.disabled = true;
                    this.pauseBtn.disabled = true;
                    this.startBtn.innerHTML = '<i class="fas fa-hourglass-half"></i> Get Ready';
                    
                    // Start countdown
                    if (this.countdownInterval) clearInterval(this.countdownInterval);
                    this.countdownInterval = setInterval(() => {
                        this.countdown--;
                        this.overlayText.textContent = `Starting in ${this.countdown}...`;
                        
                        if (this.countdown <= 0) {
                            clearInterval(this.countdownInterval);
                            this.beginGameplay();
                        }
                    }, 1000);
                    
                    // Play start sound
                    this.audioManager.playStartSound();
                }
                
                beginGameplay() {
                    this.gameState = 'running';
                    this.overlay.classList.remove('active');
                    
                    // Initialize entities
                    const config = this.getCurrentConfig();
                    this.createEntities(config.drops, config.bees);
                    
                    // Set up game timer
                    if (this.timerInterval) clearInterval(this.timerInterval);
                    this.timerInterval = setInterval(() => {
                        if (this.gameState !== 'running') return;
                        
                        this.timeLeft--;
                        this.timeEl.textContent = this.timeLeft;
                        
                        if (this.timeLeft <= 0) {
                            this.endGame();
                        }
                    }, 1000);
                    
                    // Start control update interval for mobile buttons
                    if (this.isMobile) {
                        this.startControlUpdates();
                    }
                    
                    // Update UI
                    this.startBtn.disabled = false;
                    this.pauseBtn.disabled = false;
                    this.startBtn.innerHTML = '<i class="fas fa-rotate-right"></i> Restart';
                    this.pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                    this.statusText.textContent = 'Catch honey drops! Avoid bees!';
                    
                    // Start game loop
                    this.lastFrameTime = performance.now();
                    requestAnimationFrame((time) => this.gameLoop(time));
                }
                
                startControlUpdates() {
                    if (this.controlUpdateInterval) clearInterval(this.controlUpdateInterval);
                    
                    this.controlUpdateInterval = setInterval(() => {
                        if (this.gameState !== 'running') return;
                        
                        const moveAmount = this.player.moveSpeed;
                        if (this.player.moveLeft) {
                            this.player.targetX -= moveAmount;
                        }
                        if (this.player.moveRight) {
                            this.player.targetX += moveAmount;
                        }
                    }, 16); // ~60fps
                }
                
                pause() {
                    if (this.gameState !== 'running') return;
                    
                    this.gameState = 'paused';
                    this.overlay.classList.add('active');
                    this.overlayTitle.textContent = 'Game Paused';
                    this.overlayText.textContent = 'Pooh is taking a little rest.';
                    this.overlayStats.style.display = 'none';

                    this.pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
                    this.statusText.textContent = `Game paused. ${this.isMobile ? 'Tap' : 'Click'} Resume to continue.`;
                    
                    // Stop control updates
                    if (this.controlUpdateInterval) {
                        clearInterval(this.controlUpdateInterval);
                        this.controlUpdateInterval = null;
                    }
                }
                
                resume() {
                    if (this.gameState !== 'paused') return;
                    
                    this.gameState = 'running';
                    this.overlay.classList.remove('active');
                    this.pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                    this.statusText.textContent = 'Back to catching honey!';
                    
                    // Restart control updates for mobile
                    if (this.isMobile) {
                        this.startControlUpdates();
                    }
                    
                    this.lastFrameTime = performance.now();
                    requestAnimationFrame((time) => this.gameLoop(time));
                }
                
                restart() {
                    this.endGame();
                    setTimeout(() => this.start(), 300);
                }
                
                endGame() {
                    if (this.gameState === 'gameOver') return;
                    
                    this.gameState = 'gameOver';
                    
                    // Clear intervals
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                        this.timerInterval = null;
                    }
                    
                    if (this.controlUpdateInterval) {
                        clearInterval(this.controlUpdateInterval);
                        this.controlUpdateInterval = null;
                    }
                    
                    if (this.countdownInterval) {
                        clearInterval(this.countdownInterval);
                        this.countdownInterval = null;
                    }
                    
                    // Update best score
                    this.updateBestScore();
                    
                    // Show game over screen
                    this.overlay.classList.add('active');
                    this.overlayTitle.textContent = 'Time\'s Up!';
                    this.overlayText.textContent = 'That was a lovely honey hunt!';
                    this.overlayStats.style.display = 'flex';
                    
                    this.finalScore.textContent = this.score;
                    this.finalCaught.textContent = this.caught;
                    this.finalStreak.textContent = `x${this.multiplier}`;
                    
                    // Update UI
                    this.startBtn.disabled = false;
                    this.pauseBtn.disabled = true;
                    this.startBtn.innerHTML = '<i class="fas fa-play"></i> Play Again';
                    this.pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                    
                    // Show toast with results
                    const message = `Final Score: ${this.score} | Drops: ${this.caught} | Best Streak: x${this.multiplier}`;
                    this.toastManager.show(message, 'success', 5000);
                    
                    // Play game over sound
                    this.audioManager.playGameOverSound();
                    
                    // Create confetti for high score
                    if (this.score >= this.bestScore) {
                        this.particleSystem.createConfetti();
                    }
                }
                
                // ==================== Game Logic ====================
                getCurrentConfig() {
                    const difficulty = this.difficultySelect.value;
                    const config = DIFFICULTY_CONFIG[difficulty] || DIFFICULTY_CONFIG.medium;
                    
                    // Adjust player speed based on config
                    this.player.lerpSpeed = config.playerSpeed;
                    
                    return config;
                }
                
                createEntities(dropCount, beeCount) {
                    this.entities = [];
                    
                    for (let i = 0; i < dropCount; i++) {
                        this.entities.push(this.createEntity('drop', true));
                    }
                    
                    for (let i = 0; i < beeCount; i++) {
                        this.entities.push(this.createEntity('bee', true));
                    }
                }
                
                createEntity(type, randomStart = false) {
                    const config = this.getCurrentConfig();
                    const radius = type === 'bee' ? 
                        (this.isMobile ? 18 : 16) : 
                        (this.isMobile ? 22 : 18);
                    
                    const entity = {
                        x: randomRange(radius, this.canvas.width - radius),
                        y: randomStart ? randomRange(-100, -radius) : -radius,
                        radius: radius,
                        speed: randomRange(config.minSpeed, config.maxSpeed),
                        drift: randomRange(-40, 40),
                        type: type,
                        isGolden: false,
                        wobble: 0,
                        wobbleSpeed: randomRange(0.5, 1.5),
                        wobbleAmount: randomRange(2, 5)
                    };
                    
                    if (type === 'drop' && Math.random() < 0.15) {
                        entity.isGolden = true;
                        entity.radius += 3;
                        entity.speed *= 0.9;
                    }
                    
                    return entity;
                }
                
                updateEntities(deltaTime) {
                    for (const entity of this.entities) {
                        // Update position
                        entity.y += entity.speed * deltaTime;
                        entity.x += entity.drift * deltaTime * 0.3;
                        
                        // Add wobble effect
                        entity.wobble += entity.wobbleSpeed * deltaTime;
                        entity.x += Math.sin(entity.wobble) * entity.wobbleAmount * deltaTime;
                        
                        // Boundary check
                        if (entity.x < entity.radius) {
                            entity.x = entity.radius;
                            entity.drift = Math.abs(entity.drift);
                        } else if (entity.x > this.canvas.width - entity.radius) {
                            entity.x = this.canvas.width - entity.radius;
                            entity.drift = -Math.abs(entity.drift);
                        }
                        
                        // Check for collision with player
                        if (this.checkCollision(entity)) {
                            if (entity.type === 'drop') {
                                this.catchDrop(entity);
                            } else {
                                this.hitBee(entity);
                            }
                            
                            // Respawn entity
                            this.respawnEntity(entity);
                            continue;
                        }
                        
                        // Check if entity is off screen
                        if (entity.y - entity.radius > this.canvas.height) {
                            if (entity.type === 'drop') {
                                this.missDrop();
                            }
                            this.respawnEntity(entity);
                        }
                    }
                }
                
                updatePlayer(deltaTime) {
                    // Smooth player movement
                    this.player.x = lerp(this.player.x, this.player.targetX, this.player.lerpSpeed);
                    
                    // Keep player within bounds
                    const halfWidth = this.player.width / 2;
                    this.player.x = clamp(this.player.x, halfWidth, this.canvas.width - halfWidth);
                    this.player.targetX = clamp(this.player.targetX, halfWidth, this.canvas.width - halfWidth);
                }
                
                updatePopups(deltaTime) {
                    for (let i = this.popups.length - 1; i >= 0; i--) {
                        const popup = this.popups[i];
                        
                        popup.y += popup.vy * deltaTime;
                        popup.vy *= 0.98; // Slow down
                        popup.life -= deltaTime * 0.5;
                        
                        if (popup.life <= 0) {
                            this.popups.splice(i, 1);
                        }
                    }
                }
                
                respawnEntity(entity) {
                    const newEntity = this.createEntity(entity.type, false);
                    
                    entity.x = newEntity.x;
                    entity.y = newEntity.y;
                    entity.radius = newEntity.radius;
                    entity.speed = newEntity.speed;
                    entity.drift = newEntity.drift;
                    entity.type = newEntity.type;
                    entity.isGolden = newEntity.isGolden;
                    entity.wobble = newEntity.wobble;
                    entity.wobbleSpeed = newEntity.wobbleSpeed;
                    entity.wobbleAmount = newEntity.wobbleAmount;
                }
                
                checkCollision(entity) {
                    // Simplified collision check between entity and player's barrel
                    const barrelX = this.player.x + this.player.width * 0.15;
                    const barrelY = this.player.y - 4;
                    const barrelWidth = this.player.width * 0.7;
                    const barrelHeight = this.player.height * 0.7;
                    
                    const closestX = clamp(entity.x, barrelX - barrelWidth/2, barrelX + barrelWidth/2);
                    const closestY = clamp(entity.y, barrelY - barrelHeight/2, barrelY + barrelHeight/2);
                    
                    const distanceX = entity.x - closestX;
                    const distanceY = entity.y - closestY;
                    const distanceSquared = distanceX * distanceX + distanceY * distanceY;
                    
                    return distanceSquared < (entity.radius * entity.radius);
                }
                
                catchDrop(entity) {
                    const config = this.getCurrentConfig();
                    
                    // Update combo
                    this.combo++;
                    this.multiplier = 1 + Math.floor(this.combo / 3);
                    this.multiplier = clamp(this.multiplier, 1, 5);
                    
                    // Calculate score
                    let baseScore = config.dropScore;
                    if (entity.isGolden) {
                        baseScore *= 2;
                        this.audioManager.playGoldenDropSound();
                        this.toastManager.show('Golden Drop! Double Points!', 'warning', 2000);
                    } else {
                        this.audioManager.playDropSound();
                    }
                    
                    const scoreGain = baseScore * this.multiplier;
                    
                    // Update stats
                    this.score += scoreGain;
                    this.caught++;
                    
                    // Update UI
                    this.updateStats();
                    this.streakEl.classList.add('pulse');
                    setTimeout(() => this.streakEl.classList.remove('pulse'), 500);
                    
                    // Create popup
                    this.popups.push({
                        x: entity.x,
                        y: entity.y,
                        text: `+${scoreGain}`,
                        color: entity.isGolden ? '#FFC107' : '#5D4037',
                        life: 1.5,
                        vy: -60,
                        fontSize: entity.isGolden ? 22 : 18,
                        fontWeight: 'bold'
                    });
                    
                    // Create particles
                    if (entity.isGolden) {
                        this.particleSystem.createGoldenParticles(entity.x, entity.y);
                    } else {
                        this.particleSystem.createHoneyParticles(entity.x, entity.y);
                    }
                    
                    // Update status
                    this.statusText.textContent = entity.isGolden 
                        ? `Golden drop! +${scoreGain} points! (Streak x${this.multiplier})`
                        : `Honey caught! +${scoreGain} points. (Streak x${this.multiplier})`;
                }
                
                hitBee(entity) {
                    const config = this.getCurrentConfig();
                    
                    // Reset combo
                    this.combo = 0;
                    this.multiplier = 1;
                    
                    // Apply penalties
                    this.score = Math.max(0, this.score - config.beePenalty);
                    this.timeLeft = Math.max(0, this.timeLeft - config.timePenalty);
                    
                    // Update UI
                    this.updateStats();
                    
                    // Create popup
                    this.popups.push({
                        x: entity.x,
                        y: entity.y,
                        text: `-${config.beePenalty}`,
                        color: '#D32F2F',
                        life: 1.5,
                        vy: -50,
                        fontSize: 18,
                        fontWeight: 'bold'
                    });
                    
                    // Create particles and visual effect
                    this.particleSystem.createBeeParticles(entity.x, entity.y);
                    this.beeHitTimer = 0.3;
                    this.canvas.parentElement.classList.add('shake');
                    setTimeout(() => this.canvas.parentElement.classList.remove('shake'), 500);
                    
                    // Play sound
                    this.audioManager.playBeeHitSound();
                    
                    // Update status
                    this.statusText.textContent = `Ouch! Bee bump. -${config.beePenalty} points, -${config.timePenalty} seconds.`;
                    
                    // Show warning
                    this.toastManager.show('Watch out for bees!', 'error', 2000);
                }
                
                missDrop() {
                    // Reset combo on miss
                    this.combo = 0;
                    this.multiplier = 1;
                    this.updateStats();
                    
                    this.statusText.textContent = 'A drop slipped by. Streak reset.';
                }
                
                // ==================== Input Handling ====================
                handleTouchStart(e) {
                    if (this.gameState !== 'running') return;
                    
                    e.preventDefault();
                    const rect = this.canvas.getBoundingClientRect();
                    
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        const touch = e.changedTouches[i];
                        const touchId = touch.identifier;
                        const x = touch.clientX - rect.left;
                        
                        this.activeTouches.set(touchId, x);
                        this.player.targetX = x;
                    }
                    
                    this.isDragging = true;
                }
                
                handleTouchMove(e) {
                    if (!this.isDragging || this.gameState !== 'running') return;
                    
                    e.preventDefault();
                    const rect = this.canvas.getBoundingClientRect();
                    
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        const touch = e.changedTouches[i];
                        const touchId = touch.identifier;
                        
                        if (this.activeTouches.has(touchId)) {
                            const x = touch.clientX - rect.left;
                            this.activeTouches.set(touchId, x);
                            this.player.targetX = x;
                        }
                    }
                }
                
                handleTouchEnd(e) {
                    e.preventDefault();
                    
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        const touch = e.changedTouches[i];
                        const touchId = touch.identifier;
                        this.activeTouches.delete(touchId);
                    }
                    
                    if (this.activeTouches.size === 0) {
                        this.isDragging = false;
                    }
                }
                
                handleMouseDown(e) {
                    if (this.gameState !== 'running') return;
                    
                    const rect = this.canvas.getBoundingClientRect();
                    this.player.targetX = e.clientX - rect.left;
                    this.isDragging = true;
                }
                
                handleMouseMove(e) {
                    if (!this.isDragging || this.gameState !== 'running') return;
                    
                    const rect = this.canvas.getBoundingClientRect();
                    this.player.targetX = e.clientX - rect.left;
                }
                
                handleMouseUp() {
                    this.isDragging = false;
                }
                
                handleKeyDown(e) {
                    if (e.key === ' ') {
                        e.preventDefault();
                        if (this.gameState === 'running') {
                            this.pause();
                        } else if (this.gameState === 'paused') {
                            this.resume();
                        }
                        return;
                    }

                    if (this.gameState !== 'running') return;

                    const moveAmount = 20;

                    switch(e.key) {
                        case 'ArrowLeft':
                        case 'a':
                        case 'A':
                            this.player.targetX -= moveAmount;
                            break;
                        case 'ArrowRight':
                        case 'd':
                        case 'D':
                            this.player.targetX += moveAmount;
                            break;
                    }
                }
                
                handleKeyUp(e) {
                    // Optional: Add if you want continuous movement while key is held
                }
                
                // ==================== Rendering ====================
                gameLoop(currentTime) {
                    if (this.gameState !== 'running') return;
                    
                    // Calculate delta time
                    const deltaTime = Math.min((currentTime - this.lastFrameTime) / 1000, 0.1);
                    this.lastFrameTime = currentTime;
                    
                    // Update game state
                    this.updatePlayer(deltaTime);
                    this.updateEntities(deltaTime);
                    this.updatePopups(deltaTime);
                    
                    // Update visual effects
                    this.cloudOffset += deltaTime * 15;
                    if (this.beeHitTimer > 0) {
                        this.beeHitTimer = Math.max(0, this.beeHitTimer - deltaTime);
                    }
                    
                    // Update background particles
                    this.particleSystem.update();
                    
                    // Draw everything
                    this.draw();
                    
                    // Continue game loop
                    requestAnimationFrame((time) => this.gameLoop(time));
                }
                
                draw() {
                    // Clear canvas
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Draw background
                    this.drawBackground();
                    
                    // Draw entities
                    this.drawEntities();
                    
                    // Draw player
                    this.drawPlayer();
                    
                    // Draw popups
                    this.drawPopups();
                    
                    // Draw bee hit effect
                    if (this.beeHitTimer > 0) {
                        this.ctx.fillStyle = `rgba(214, 69, 69, ${this.beeHitTimer})`;
                        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    }
                    
                    // Draw countdown if active
                    if (this.gameState === 'countdown' && this.countdown > 0) {
                        this.drawCountdown();
                    }
                }
                
                drawBackground() {
                    const ctx = this.ctx;
                    const width = this.canvas.width;
                    const height = this.canvas.height;
                    
                    // Sky gradient
                    const skyGradient = ctx.createLinearGradient(0, 0, 0, height);
                    skyGradient.addColorStop(0, '#cbe3ff');
                    skyGradient.addColorStop(0.6, '#e9f2ff');
                    skyGradient.addColorStop(1, '#ffe59c');
                    ctx.fillStyle = skyGradient;
                    ctx.fillRect(0, 0, width, height);
                    
                    // Distant hills
                    ctx.fillStyle = '#b5d28d';
                    ctx.beginPath();
                    ctx.moveTo(0, height - 80);
                    ctx.bezierCurveTo(width * 0.2, height - 140, width * 0.5, height - 90, width, height - 110);
                    ctx.lineTo(width, height);
                    ctx.lineTo(0, height);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.fillStyle = '#9fc46f';
                    ctx.beginPath();
                    ctx.moveTo(0, height - 60);
                    ctx.bezierCurveTo(width * 0.3, height - 100, width * 0.7, height - 60, width, height - 80);
                    ctx.lineTo(width, height);
                    ctx.lineTo(0, height);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Ground
                    ctx.fillStyle = '#8bc34a';
                    ctx.fillRect(0, height - 35, width, 35);
                    
                    // Grass detail
                    ctx.fillStyle = '#7cb342';
                    for (let i = 0; i < 20; i++) {
                        const x = (width / 20) * i;
                        const heightVariation = Math.sin(i * 0.5 + this.cloudOffset * 0.1) * 5;
                        ctx.fillRect(x, height - 35, 3, 8 + heightVariation);
                    }
                    
                    // Clouds
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    this.drawCloud(ctx, (this.cloudOffset * 0.4) % (width + 200) - 100, 50, 70);
                    this.drawCloud(ctx, (this.cloudOffset * 0.3 + 150) % (width + 250) - 125, 80, 90);
                    this.drawCloud(ctx, (this.cloudOffset * 0.25 + 300) % (width + 300) - 150, 60, 60);
                }
                
                drawCloud(ctx, x, y, size) {
                    ctx.beginPath();
                    ctx.arc(x, y, size * 0.5, 0, Math.PI * 2);
                    ctx.arc(x + size * 0.4, y + size * 0.1, size * 0.45, 0, Math.PI * 2);
                    ctx.arc(x - size * 0.4, y + size * 0.15, size * 0.4, 0, Math.PI * 2);
                    ctx.arc(x + size * 0.1, y - size * 0.2, size * 0.35, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                drawPlayer() {
                    const ctx = this.ctx;
                    const x = this.player.x;
                    const y = this.player.y;
                    const width = this.player.width;
                    const height = this.player.height;

                    const furBase = '#f4c87a';
                    const furDeep = '#e3a850';
                    const outfit = '#c86d5a';

                    // Simple bobbing animation
                    const bob = Math.sin(Date.now() * 0.005) * 2;
                    
                    // Draw shadow
                    ctx.fillStyle = 'rgba(62, 39, 35, 0.2)';
                    ctx.beginPath();
                    ctx.ellipse(x, y + height/2, width * 0.6, height * 0.3, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw Pooh body (simple oval)
                    ctx.fillStyle = furBase;
                    ctx.beginPath();
                    ctx.ellipse(x, y - 5 + bob, width * 0.4, height * 0.4, 0, 0, Math.PI * 2);
                    ctx.fill();

                    // Draw simple top band
                    ctx.fillStyle = outfit;
                    ctx.beginPath();
                    ctx.ellipse(x, y + 15 + bob, width * 0.45, height * 0.5, 0, 0, Math.PI * 2);
                    ctx.fill();

                    // Draw head
                    ctx.fillStyle = furDeep;
                    ctx.beginPath();
                    ctx.arc(x - 5, y - 40 + bob, 25, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw ears
                    ctx.beginPath();
                    ctx.arc(x - 20, y - 55 + bob, 8, 0, Math.PI * 2);
                    ctx.arc(x + 10, y - 55 + bob, 8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw eyes
                    ctx.fillStyle = '#3E2723';
                    ctx.beginPath();
                    ctx.arc(x - 10, y - 45 + bob, 4, 0, Math.PI * 2);
                    ctx.arc(x + 0, y - 45 + bob, 4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw nose
                    ctx.fillStyle = '#3E2723';
                    ctx.beginPath();
                    ctx.ellipse(x - 5, y - 35 + bob, 6, 5, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw smile
                    ctx.strokeStyle = '#3E2723';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x - 5, y - 30 + bob, 10, 0.2, 0.8 * Math.PI);
                    ctx.stroke();
                    
                    // Draw honey barrel
                    const barrelWidth = this.isMobile ? 70 : 60;
                    const barrelHeight = this.isMobile ? 45 : 40;
                    
                    // Barrel body
                    ctx.fillStyle = '#8D6E63';
                    ctx.fillRect(x - barrelWidth/2, y + 20 + bob, barrelWidth, barrelHeight);
                    
                    // Barrel hoops
                    ctx.fillStyle = '#5D4037';
                    ctx.fillRect(x - barrelWidth/2, y + 25 + bob, barrelWidth, 4);
                    ctx.fillRect(x - barrelWidth/2, y + 45 + bob, barrelWidth, 4);
                    
                    // Honey inside
                    ctx.fillStyle = '#FFD600';
                    ctx.beginPath();
                    ctx.ellipse(x, y + 40 + bob, barrelWidth * 0.4, barrelHeight * 0.3, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Barrel label
                    ctx.fillStyle = '#FFECB3';
                    ctx.font = 'bold 12px Schoolbell';
                    ctx.textAlign = 'center';
                    ctx.fillText('HONEY', x, y + 40 + bob);
                }
                
                drawEntities() {
                    for (const entity of this.entities) {
                        // Shadow
                        this.ctx.fillStyle = 'rgba(62, 39, 35, 0.2)';
                        this.ctx.beginPath();
                        this.ctx.ellipse(entity.x, entity.y + entity.radius * 0.9, 
                                       entity.radius * 0.9, entity.radius * 0.3, 0, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        if (entity.type === 'drop') {
                            this.drawDrop(entity);
                        } else {
                            this.drawBee(entity);
                        }
                    }
                }
                
                drawDrop(entity) {
                    const ctx = this.ctx;
                    const r = entity.radius;
                    
                    // Glow effect
                    ctx.save();
                    ctx.shadowColor = entity.isGolden ? 'rgba(255, 193, 7, 0.8)' : 'rgba(255, 215, 64, 0.7)';
                    ctx.shadowBlur = 15;
                    
                    // Drop shape
                    ctx.fillStyle = entity.isGolden ? '#FFD54F' : '#FFEC80';
                    ctx.beginPath();
                    ctx.moveTo(entity.x, entity.y - r);
                    ctx.quadraticCurveTo(entity.x + r, entity.y, entity.x, entity.y + r);
                    ctx.quadraticCurveTo(entity.x - r, entity.y, entity.x, entity.y - r);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.restore();
                    
                    // Highlight
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.beginPath();
                    ctx.ellipse(entity.x - r * 0.3, entity.y - r * 0.4, r * 0.25, r * 0.3, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Golden drop star
                    if (entity.isGolden) {
                        ctx.save();
                        ctx.fillStyle = '#FFF';
                        ctx.translate(entity.x, entity.y);
                        ctx.rotate(entity.wobble * 0.5);
                        
                        ctx.beginPath();
                        for (let i = 0; i < 5; i++) {
                            const angle = (i * 2 * Math.PI) / 5;
                            const spikeX = Math.cos(angle) * (r * 0.6);
                            const spikeY = Math.sin(angle) * (r * 0.6);
                            ctx.lineTo(spikeX, spikeY);
                        }
                        ctx.closePath();
                        ctx.fill();
                        ctx.restore();
                    }
                }
                
                drawBee(entity) {
                    const ctx = this.ctx;
                    const r = entity.radius;
                    
                    // Wings
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.beginPath();
                    const wingFlap = Math.sin(entity.wobble * 3) * 0.3;
                    ctx.ellipse(entity.x - r * 0.1, entity.y - r * 0.7, 
                              r * 0.5, r * 0.3 + wingFlap, -0.3, 0, Math.PI * 2);
                    ctx.ellipse(entity.x + r * 0.1, entity.y - r * 0.7, 
                              r * 0.5, r * 0.3 + wingFlap, 0.3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Body
                    ctx.beginPath();
                    ctx.ellipse(entity.x, entity.y, r * 0.9, r * 0.6, 0, 0, Math.PI * 2);
                    ctx.fillStyle = '#FFEB3B';
                    ctx.fill();
                    
                    // Stripes
                    ctx.fillStyle = '#424242';
                    ctx.beginPath();
                    ctx.ellipse(entity.x - r * 0.25, entity.y, r * 0.15, r * 0.6, 0, 0, Math.PI * 2);
                    ctx.ellipse(entity.x + r * 0.05, entity.y, r * 0.15, r * 0.6, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Head
                    ctx.beginPath();
                    ctx.arc(entity.x + r * 0.7, entity.y - r * 0.1, r * 0.35, 0, Math.PI * 2);
                    ctx.fillStyle = '#424242';
                    ctx.fill();
                    
                    // Eye
                    ctx.fillStyle = '#FFF';
                    ctx.beginPath();
                    ctx.arc(entity.x + r * 0.82, entity.y - r * 0.18, r * 0.12, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#212121';
                    ctx.beginPath();
                    ctx.arc(entity.x + r * 0.84, entity.y - r * 0.18, r * 0.07, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Antenna
                    ctx.strokeStyle = '#424242';
                    ctx.lineWidth = 1.5;
                    ctx.beginPath();
                    ctx.moveTo(entity.x + r * 0.85, entity.y - r * 0.25);
                    ctx.lineTo(entity.x + r * 0.95, entity.y - r * 0.4);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(entity.x + r * 0.75, entity.y - r * 0.3);
                    ctx.lineTo(entity.x + r * 0.85, entity.y - r * 0.45);
                    ctx.stroke();
                }
                
                drawPopups() {
                    for (const popup of this.popups) {
                        this.ctx.save();
                        this.ctx.globalAlpha = popup.life;
                        this.ctx.fillStyle = popup.color;
                        this.ctx.font = `${popup.fontWeight} ${popup.fontSize}px "Nunito"`;
                        this.ctx.textAlign = 'center';
                        this.ctx.textBaseline = 'middle';
                        this.ctx.fillText(popup.text, popup.x, popup.y);
                        this.ctx.restore();
                    }
                }
                
                drawCountdown() {
                    this.ctx.save();
                    this.ctx.globalAlpha = 0.9;
                    this.ctx.fillStyle = '#5D4037';
                    this.ctx.font = 'bold 80px "Schoolbell"';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(this.countdown, this.canvas.width / 2, this.canvas.height / 2);
                    this.ctx.restore();
                }
                
                drawIdleScreen() {
                    // Set player to center
                    this.player.x = this.canvas.width / 2;
                    this.player.y = this.canvas.height - 52;
                    this.player.targetX = this.player.x;
                    
                    // Draw background
                    this.drawBackground();
                    
                    // Draw player
                    this.drawPlayer();
                    
                    // Draw title
                    this.ctx.fillStyle = '#5D4037';
                    this.ctx.font = 'bold 24px "Schoolbell"';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('Help Pooh catch honeybee drops!', this.canvas.width / 2, 50);

                    this.ctx.font = '16px "Nunito"';
                    this.ctx.fillStyle = '#6D4C41';
                    const instruction = this.isMobile 
                        ? 'Tap Start, then drag or use buttons to move Pooh.'
                        : 'Click Start, then use arrow keys or mouse to move Pooh.';
                    this.ctx.fillText(instruction, this.canvas.width / 2, 80);
                }
                
                // ==================== UI Updates ====================
                updateStats() {
                    this.scoreEl.textContent = this.score;
                    this.timeEl.textContent = this.timeLeft;
                    this.caughtEl.textContent = this.caught;
                    this.streakEl.textContent = `x${this.multiplier}`;
                }
                
                updateBestScore() {
                    if (this.score > this.bestScore) {
                        this.bestScore = this.score;
                        this.bestEl.textContent = this.bestScore;
                        this.saveBestScore();
                        
                        // Show celebration
                        this.toastManager.show(`New High Score: ${this.bestScore}!`, 'success', 5000);
                    }
                }
                
                // ==================== Storage Management ====================
                loadBestScore() {
                    try {
                        const stored = localStorage.getItem(STORAGE_KEYS.BEST_SCORE);
                        this.bestScore = stored ? parseInt(stored, 10) : 0;
                        this.bestEl.textContent = this.bestScore;
                    } catch (e) {
                        this.bestScore = 0;
                    }
                }
                
                saveBestScore() {
                    try {
                        localStorage.setItem(STORAGE_KEYS.BEST_SCORE, this.bestScore.toString());
                    } catch (e) {
                        console.warn('Failed to save high score');
                    }
                }
                
                loadDifficulty() {
                    try {
                        const stored = localStorage.getItem(STORAGE_KEYS.DIFFICULTY);
                        if (stored && DIFFICULTY_CONFIG[stored]) {
                            this.difficultySelect.value = stored;
                        }
                    } catch (e) {
                        // Use default
                    }
                }
                
                saveDifficulty() {
                    try {
                        localStorage.setItem(STORAGE_KEYS.DIFFICULTY, this.difficultySelect.value);
                    } catch (e) {
                        console.warn('Failed to save difficulty setting');
                    }
                }
                
                // ==================== Canvas Management ====================
                resizeCanvas() {
                    const container = this.canvas.parentElement;
                    if (!container) return;

                    this.isLandscape = window.innerWidth > window.innerHeight;
                    const width = container.clientWidth;
                    const containerRect = container.getBoundingClientRect();
                    const viewportAllowance = window.innerHeight - containerRect.top - 140;

                    const viewportRatio = window.innerWidth / Math.max(window.innerHeight, 1);

                    // Aspect ratios are expressed as height divided by width
                    const aspectRatio = this.isMobile
                        ? (this.isLandscape ? 0.65 : 0.85)
                        : (viewportRatio > 1.4 ? 0.6 : 0.75);

                    const targetHeight = width * aspectRatio;
                    const maxHeight = this.isMobile ? 520 : 640;
                    const minHeight = this.isMobile ? 260 : 320;
                    const boundedHeight = viewportAllowance > 0
                        ? Math.min(targetHeight, viewportAllowance)
                        : targetHeight;
                    const height = clamp(boundedHeight, minHeight, maxHeight);

                    this.canvas.width = width;
                    this.canvas.height = height;
                    
                    // Update player position
                    this.player.y = height - 52;
                    if (!this.player.x || this.player.x < this.player.width/2 || this.player.x > width - this.player.width/2) {
                        this.player.x = width / 2;
                        this.player.targetX = this.player.x;
                    }
                    
                    // Update mobile controls display
                    this.toggleMobileControls();
                    
                    // Redraw if game is idle
                    if (this.gameState === 'idle') {
                        this.drawIdleScreen();
                    }
                }
                
                // ==================== Background Animation ====================
                animateBackground() {
                    let lastTime = 0;
                    const animate = (currentTime) => {
                        // Throttle updates for performance on mobile
                        if (currentTime - lastTime > (this.isMobile ? 32 : 16)) { // 30fps on mobile, 60fps on desktop
                            this.particleSystem.update();
                            this.particleSystem.draw();
                            lastTime = currentTime;
                        }
                        requestAnimationFrame(animate);
                    };
                    animate(0);
                }
            }
            
            // ==================== Initialize Game ====================
            window.addEventListener('DOMContentLoaded', () => {
                // Prevent zoom on mobile
                document.addEventListener('touchmove', function(e) {
                    if(e.scale !== 1) e.preventDefault();
                }, { passive: false });
                
                // Create and initialize game
                window.poohHoneyBarrelGame = new PoohHoneyBarrelGame();
            });
            
        })();
    </script>
</body>
</html>
